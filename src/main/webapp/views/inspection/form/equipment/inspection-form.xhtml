<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:pe="http://primefaces.org/ui/extensions"
                xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:o="http://omnifaces.org/ui" xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/template.xhtml">

    <ui:define name="head">
        <h:outputStylesheet library="#{appSetting.resourceLib}"
                            name="css/material-theme.css"></h:outputStylesheet>
        <!-- إضافة خطوط Google Fonts -->
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;family=Poppins:wght@400;500;600;700&amp;family=Playfair+Display:wght@400;500;600;700&amp;display=swap" rel="stylesheet" />
        <style>
            /* نظام الألوان الجديد */
            :root {
                /* الألوان الأساسية */
                --primary-50: #f0f9ff;
                --primary-100: #e0f2fe;
                --primary-200: #bae6fd;
                --primary-300: #7dd3fc;
                --primary-400: #38bdf8;
                --primary-500: #0ea5e9;
                --primary-600: #0284c7;
                --primary-700: #0369a1;
                --primary-800: #075985;
                --primary-900: #0c4a6e;

                /* الأخضر الفاتح */
                --mint-50: #f0fdfa;
                --mint-100: #ccfbf1;
                --mint-200: #99f6e4;
                --mint-300: #5eead4;
                --mint-400: #2dd4bf;
                --mint-500: #14b8a6;
                --mint-600: #0d9488;
                --mint-700: #0f766e;
                --mint-800: #115e59;
                --mint-900: #134e4a;

                /* العسلي */
                --hazel-50: #fefce8;
                --hazel-100: #fef9c3;
                --hazel-200: #fef08a;
                --hazel-300: #fde047;
                --hazel-400: #facc15;
                --hazel-500: #eab308;
                --hazel-600: #ca8a04;
                --hazel-700: #a16207;
                --hazel-800: #854d0e;
                --hazel-900: #713f12;

                /* البنفسجي */
                --purple-50: #faf5ff;
                --purple-100: #f3e8ff;
                --purple-200: #e9d5ff;
                --purple-300: #d8b4fe;
                --purple-400: #c084fc;
                --purple-500: #a855f7;
                --purple-600: #9333ea;
                --purple-700: #7c3aed;
                --purple-800: #6b21a8;
                --purple-900: #581c87;

                /* الألوان المساعدة */
                --success-50: #f0fdf4;
                --success-100: #dcfce7;
                --success-200: #bbf7d0;
                --success-300: #86efac;
                --success-400: #4ade80;
                --success-500: #22c55e;
                --success-600: #16a34a;
                --success-700: #15803d;
                --success-800: #166534;
                --success-900: #14532d;

                --warning-50: #fffbeb;
                --warning-100: #fef3c7;
                --warning-200: #fde68a;
                --warning-300: #fcd34d;
                --warning-400: #fbbf24;
                --warning-500: #f59e0b;
                --warning-600: #d97706;
                --warning-700: #b45309;
                --warning-800: #92400e;
                --warning-900: #78350f;

                --danger-50: #fef2f2;
                --danger-100: #fee2e2;
                --danger-200: #fecaca;
                --danger-300: #fca5a5;
                --danger-400: #f87171;
                --danger-500: #ef4444;
                --danger-600: #dc2626;
                --danger-700: #b91c1c;
                --danger-800: #991b1b;
                --danger-900: #7f1d1d;

                --info-50: #f0f9ff;
                --info-100: #e0f2fe;
                --info-200: #bae6fd;
                --info-300: #7dd3fc;
                --info-400: #38bdf8;
                --info-500: #0ea5e9;
                --info-600: #0284c7;
                --info-700: #0369a1;
                --info-800: #075985;
                --info-900: #0c4a6e;

                --surface-0: #ffffff;
                --surface-50: #f8fafc;
                --surface-100: #f1f5f9;
                --surface-200: #e2e8f0;
                --surface-300: #cbd5e1;
                --surface-400: #94a3b8;
                --surface-500: #64748b;
                --surface-600: #475569;
                --surface-700: #334155;
                --surface-800: #1e293b;
                --surface-900: #0f172a;
                --surface-950: #020617;

                /* الظلال */
                --shadow-sm: 0 1px 3px rgba(15, 23, 42, 0.08);
                --shadow: 0 1px 3px rgba(15, 23, 42, 0.1), 0 1px 2px rgba(15, 23, 42, 0.06);
                --shadow-md: 0 4px 12px rgba(15, 23, 42, 0.12);
                --shadow-lg: 0 10px 25px rgba(15, 23, 42, 0.15);
                --shadow-xl: 0 20px 40px rgba(15, 23, 42, 0.18);
                --shadow-2xl: 0 25px 50px -12px rgba(15, 23, 42, 0.25);
                --shadow-inner: inset 0 2px 4px 0 rgba(15, 23, 42, 0.06);
                --glass-shadow: 0 8px 32px 0 rgba(15, 23, 42, 0.15);
                --mint-glow: 0 0 20px rgba(20, 184, 166, 0.4);
                --purple-glow: 0 0 20px rgba(168, 85, 247, 0.4);
                --hazel-glow: 0 0 20px rgba(234, 179, 8, 0.4);

                /* الزوايا */
                --radius-sm: 8px;
                --radius: 12px;
                --radius-md: 14px;
                --radius-lg: 16px;
                --radius-xl: 20px;
                --radius-2xl: 24px;
                --radius-3xl: 32px;
                --radius-full: 9999px;

                /* الانتقالات */
                --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);

                /* التدرجات */
                --gradient-mint: linear-gradient(135deg, var(--mint-400) 0%, var(--mint-600) 100%);
                --gradient-purple: linear-gradient(135deg, var(--purple-400) 0%, var(--purple-600) 100%);
                --gradient-hazel: linear-gradient(135deg, var(--hazel-400) 0%, var(--hazel-600) 100%);
                --gradient-primary: linear-gradient(135deg, var(--primary-400) 0%, var(--primary-600) 100%);
                --gradient-danger: linear-gradient(135deg, var(--danger-500), var(--danger-700));
                --gradient-warning: linear-gradient(135deg, var(--warning-500), var(--warning-700));
                --gradient-success: linear-gradient(135deg, var(--success-500), var(--success-700));
                --gradient-card: linear-gradient(135deg, rgba(255, 255, 255, 0.96) 0%, rgba(248, 250, 252, 0.98) 100%);
            }

            /* تحسينات الخطوط والمظهر العام */
            body {
                background-color: var(--surface-50) !important;
                background-image:
                        radial-gradient(at 40% 20%, rgba(241, 245, 249, 0.7) 0px, transparent 50%),
                        radial-gradient(at 80% 0%, rgba(226, 232, 240, 0.5) 0px, transparent 50%),
                        radial-gradient(at 0% 50%, rgba(248, 250, 252, 0.6) 0px, transparent 50%),
                        radial-gradient(at 80% 50%, rgba(203, 213, 225, 0.4) 0px, transparent 50%);
                color: var(--surface-800);
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                line-height: 1.6;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                font-size: 0.9375rem;
            }

            /* تحسين تنسيق النصوص والعناوين */
            h1, h2, h3, h4, h5, h6 {
                font-family: 'Playfair Display', 'Poppins', serif;
                font-weight: 600;
                line-height: 1.3;
                margin-bottom: 1rem;
            }

            /* تصميم البطاقات بأنماط مختلفة لكل قسم */
            .card {
                background: var(--gradient-card);
                border-radius: var(--radius-xl);
                box-shadow: var(--shadow-lg), var(--glass-shadow);
                border: 1px solid rgba(226, 232, 240, 0.3);
                backdrop-filter: blur(12px);
                position: relative;
                overflow: hidden;
                margin-bottom: 2rem;
                transform: translateY(0);
                animation: cardSlideIn 0.6s ease-out forwards;
                transition: var(--transition-slow);
                padding: 2rem;
            }

            .card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 6px;
                background: var(--gradient-primary);
                z-index: 1;
            }

            /* بطاقة إدارة المسودات - باللون الأخضر الفاتح */
            .draft-management-card {
                border-top: 4px solid var(--mint-500);
            }

            .draft-management-card::before {
                background: var(--gradient-mint);
            }

            /* بطاقة المعلومات الأساسية - باللون العسلي */
            .basic-info-card {
                border-top: 4px solid var(--hazel-500);
            }

            .basic-info-card::before {
                background: var(--gradient-hazel);
            }

            /* بطاقة المحتوى الديناميكي - باللون البنفسجي */
            .dynamic-content-card {
                border-top: 4px solid var(--purple-500);
            }

            .dynamic-content-card::before {
                background: var(--gradient-purple);
            }

            /* بطاقة الموافقة - باللون الأزرق */
            .approval-card {
                border-top: 4px solid var(--primary-500);
            }

            .approval-card::before {
                background: var(--gradient-primary);
            }

            @keyframes cardSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .card:hover {
                transform: translateY(-8px);
                box-shadow: var(--shadow-xl), 0 8px 25px rgba(15, 23, 42, 0.15);
            }

            .draft-management-card:hover {
                box-shadow: var(--shadow-xl), var(--mint-glow);
            }

            .basic-info-card:hover {
                box-shadow: var(--shadow-xl), var(--hazel-glow);
            }

            .dynamic-content-card:hover {
                box-shadow: var(--shadow-xl), var(--purple-glow);
            }

            .approval-card:hover {
                box-shadow: var(--shadow-xl), 0 8px 25px rgba(14, 165, 233, 0.25);
            }

            /* Typography مع ألوان متنوعة */
            .smat-label {
                font-weight: 600;
                color: var(--surface-700);
                font-size: 0.875rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                margin-bottom: 0.5rem;
                display: block;
                font-family: 'Poppins', sans-serif;
            }

            h3.smat-label {
                font-size: 1.85rem;
                font-weight: 700;
                background: var(--gradient-primary);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                text-transform: none;
                letter-spacing: -0.025em;
                margin-bottom: 1.5rem;
                line-height: 1.2;
                padding-bottom: 0.75rem;
                border-bottom: 2px solid var(--primary-200);
                font-family: 'Playfair Display', serif;
                position: relative;
            }

            h3.smat-label:after {
                content: "";
                position: absolute;
                bottom: -2px;
                left: 0;
                width: 80px;
                height: 3px;
                background: var(--gradient-primary);
                border-radius: 3px;
            }

            /* Premium Form Elements with Colorful Focus States */
            .ui-inputtext,
            .ui-selectonemenu,
            .ui-inputtextarea,
            .ui-calendar {
                border: 2px solid rgba(203, 213, 225, 0.4);
                border-radius: var(--radius-md);
                padding: 0.85rem 1rem;
                font-size: 0.9375rem;
                background: rgba(255, 255, 255, 0.85);
                transition: var(--transition);
                box-shadow: var(--shadow-sm);
                width: 100%;
                color: var(--surface-800);
                font-family: 'Inter', sans-serif;
            }

            .ui-inputtext:focus,
            .ui-selectonemenu:focus,
            .ui-inputtextarea:focus,
            .ui-calendar:focus {
                outline: none;
                border-color: var(--primary-500);
                box-shadow: 0 0 0 3px var(--primary-100), var(--shadow-md);
                background-color: var(--primary-50);
                transform: translateY(-2px);
            }

            .ui-inputtext:hover,
            .ui-selectonemenu:hover,
            .ui-inputtextarea:hover,
            .ui-calendar:hover {
                border-color: var(--primary-400);
                background-color: var(--surface-50);
                box-shadow: var(--shadow-sm), 0 0 0 1px rgba(14, 165, 233, 0.2);
            }

            .input-text-smat-background {
                background: var(--surface-50);
                border-color: var(--surface-300);
                box-shadow: var(--shadow-inner);
            }

            /* SelectOneMenu */
            .ui-selectonemenu {
                appearance: none;
                background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%230ea5e9'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 0.75rem center;
                background-size: 1.25rem;
                padding-right: 2.5rem;
            }

            /* Checkbox Styling */
            body .ui-chkbox .ui-chkbox-box {
                width: 1.25rem;
                height: 1.25rem;
                border: 2px solid var(--primary-300);
                border-radius: var(--radius-sm);
                background: var(--surface-0);
                transition: var(--transition);
                position: relative;
            }

            body .ui-chkbox .ui-chkbox-box.ui-state-active {
                background: var(--gradient-primary);
                border-color: var(--primary-500);
                box-shadow: 0 0 0 2px var(--primary-100);
            }

            body .ui-chkbox .ui-chkbox-box.ui-state-active .ui-chkbox-icon {
                color: white;
            }

            body .ui-chkbox .ui-chkbox-box.ui-state-focus {
                box-shadow: 0 0 0 3px var(--primary-100);
                border-color: var(--primary-500);
            }

            /* Panel Grid - Premium Table with Colorful Header */
            .ui-panelgrid .custom-panel-grid {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
                border-radius: var(--radius-xl);
                overflow: hidden;
                box-shadow: var(--shadow-lg);
                background: var(--surface-0);
                border: 1px solid rgba(226, 232, 240, 0.3);
            }

            .ui-panelgrid .custom-panel-grid tr td {
                padding: 1rem;
                border: 1px solid var(--surface-200);
                background: var(--surface-0);
                transition: var(--transition);
                font-family: 'Inter', sans-serif;
            }

            .ui-panelgrid .custom-panel-grid tr:hover td {
                background: var(--surface-50);
            }

            .ui-panelgrid .custom-panel-grid thead tr {
                background: var(--gradient-primary);
                color: white;
            }

            .ui-panelgrid .custom-panel-grid thead tr td {
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                padding: 1.25rem 1.5rem;
                border-color: var(--primary-600);
                text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
                font-family: 'Poppins', sans-serif;
                font-size: 0.9rem;
            }

            /* Premium Buttons with Hover Effects */
            .ui-button {
                border-radius: var(--radius-full);
                font-weight: 600;
                letter-spacing: 0.05em;
                padding: 0.75rem 1.75rem;
                position: relative;
                overflow: hidden;
                transition: var(--transition-slow);
                box-shadow: var(--shadow);
                border: none;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 0.6rem;
                font-size: 0.9rem;
                min-width: 140px;
                height: 44px;
                font-family: 'Poppins', sans-serif;
            }

            .ui-button::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 5px;
                height: 5px;
                background: rgba(255, 255, 255, 0.5);
                opacity: 0;
                border-radius: 100%;
                transform: scale(1, 1) translate(-50%);
                transform-origin: 50% 50%;
            }

            .ui-button:hover::after {
                animation: ripple 1s ease-out;
            }

            @keyframes ripple {
                0% {
                    transform: scale(0, 0);
                    opacity: 0.5;
                }
                100% {
                    transform: scale(20, 20);
                    opacity: 0;
                }
            }

            .ui-button:hover {
                transform: translateY(-4px) scale(1.02);
                box-shadow: var(--shadow-lg);
            }

            .ui-button:active {
                transform: translateY(0);
                box-shadow: var(--shadow-md);
            }

            .ui-button-danger {
                background: var(--gradient-danger) !important;
                color: white !important;
            }

            .ui-button-warning {
                background: var(--gradient-warning) !important;
                color: white !important;
            }

            .ui-button-success {
                background: var(--gradient-success) !important;
                color: white !important;
            }

            .ui-button-help {
                background: var(--gradient-primary) !important;
                color: white !important;
            }

            .ui-button-info {
                background: var(--gradient-mint) !important;
                color: white !important;
            }

            /* تحسين التخطيط للأزرار السفلية */
            .action-buttons-container {
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                margin-top: 2rem;
                padding-top: 1.5rem;
                border-top: 1px solid rgba(203, 213, 225, 0.3);
                gap: 1rem;
            }

            .left-buttons-group {
                display: flex;
                gap: 0.75rem;
                flex-wrap: wrap;
                align-items: center;
            }

            .right-buttons-group {
                display: flex;
                gap: 0.75rem;
                flex-wrap: wrap;
                align-items: center;
                justify-content: flex-end;
            }

            /* Responsive adjustments for buttons */
            @media (max-width: 768px) {
                .action-buttons-container {
                    flex-direction: column;
                    gap: 1rem;
                }

                .left-buttons-group,
                .right-buttons-group {
                    width: 100%;
                    justify-content: center;
                }

                .right-buttons-group {
                    margin-top: 0.5rem;
                }
            }

            /* Chip Styling */
            .ui-chip {
                background: linear-gradient(90deg, var(--primary-100), var(--mint-100));
                color: var(--primary-800);
                border-radius: var(--radius-full);
                padding: 0.6rem 1.2rem;
                box-shadow: var(--shadow-sm);
                transition: var(--transition);
                display: inline-flex;
                align-items: center;
                font-weight: 500;
                border: 1px solid var(--primary-200);
                font-family: 'Inter', sans-serif;
                backdrop-filter: blur(8px);
            }

            .ui-chip:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow);
                background: linear-gradient(90deg, var(--primary-200), var(--mint-200));
            }

            .ui-chip-icon {
                margin-right: 0.5rem;
                color: var(--primary-600);
            }

            /* Signature Styling */
            .ui-signature {
                border: 2px dashed var(--primary-200);
                border-radius: var(--radius-lg);
                background: var(--surface-50);
                transition: var(--transition);
                background-image:
                        linear-gradient(to right, var(--primary-50) 1px, transparent 1px),
                        linear-gradient(to bottom, var(--primary-50) 1px, transparent 1px);
                background-size: 20px 20px;
                backdrop-filter: blur(4px);
            }

            .ui-signature:hover {
                border-color: var(--primary-400);
                background-color: var(--primary-50);
                box-shadow: 0 0 20px rgba(14, 165, 233, 0.2);
            }

            /* Divider Styling */
            .ui-divider {
                margin: 2rem 0;
                border: none;
                height: 1px;
                background: linear-gradient(90deg, transparent, var(--primary-400), transparent);
                opacity: 0.5;
            }

            .ui-divider-solid {
                background: var(--primary-300);
            }

            /* Field Group Styling with Colorful Accent */
            .field {
                margin-bottom: 1.5rem;
                position: relative;
                padding-left: 1.5rem;
            }

            .field::before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 4px;
                background: var(--gradient-primary);
                border-radius: var(--radius-full);
                opacity: 0.8;
                transition: var(--transition);
            }

            .field:focus-within::before {
                opacity: 1;
                width: 6px;
            }

            /* Premium Dialog Styling */
            .ui-dialog {
                border-radius: var(--radius-2xl);
                box-shadow: var(--shadow-2xl), var(--glass-shadow);
                border: 1px solid rgba(226, 232, 240, 0.3);
                overflow: hidden;
                border-top: 4px solid var(--primary-500);
                backdrop-filter: blur(12px);
                background: rgba(255, 255, 255, 0.95);
            }

            .ui-dialog .ui-dialog-titlebar {
                background: var(--gradient-primary);
                color: white;
                border-radius: 0;
                padding: 1.25rem 1.5rem;
                font-weight: 600;
                text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
                font-family: 'Poppins', sans-serif;
            }

            .ui-dialog .ui-dialog-content {
                padding: 1.5rem;
                background: transparent;
            }

            /* Premium Growl Notifications */
            .ui-growl {
                top: 25px;
                right: 25px;
            }

            .ui-growl-item-container {
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-xl), var(--glass-shadow);
                overflow: hidden;
                border-left: 4px solid var(--primary-500);
                backdrop-filter: blur(10px);
                background: rgba(255, 255, 255, 0.95);
                border: 1px solid rgba(226, 232, 240, 0.3);
            }

            .ui-growl-message {
                padding: 1rem;
                font-family: 'Inter', sans-serif;
            }

            .ui-growl-icon-close {
                top: 0.5rem;
                right: 0.5rem;
            }

            /* Status Dialog with Animation */
            .pi-spinner {
                animation: spin 1s linear infinite;
                color: var(--primary-500);
                filter: drop-shadow(0 0 2px rgba(14, 165, 233, 0.5));
            }

            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }

            /* Additional Premium Elements */
            .pe\:documentViewer {
                border-radius: var(--radius-lg);
                overflow: hidden;
                box-shadow: var(--shadow);
                border: 1px solid var(--primary-200);
            }

            /* Hover effects for all interactive elements */
            a, button, .ui-button, .ui-selectonemenu,
            .ui-inputtext, .ui-inputtextarea, .ui-chkbox {
                transition: var(--transition);
            }

            /* Responsive adjustments */
            @media (max-width: 768px) {
                .card {
                    margin: 1rem;
                    border-radius: var(--radius-lg);
                    padding: 1.5rem;
                }

                .ui-inputtext, .ui-selectonemenu, .ui-inputtextarea {
                    font-size: 1rem;
                    padding: 1rem;
                }

                .col-lg-1, .col-lg-2, .col-lg-3, .col-lg-4,
                .col-lg-5, .col-lg-6, .col-lg-7, .col-lg-8,
                .col-lg-9, .col-lg-10, .col-lg-11, .col-lg-12,
                .col-xl-1, .col-xl-2, .col-xl-3, .col-xl-4,
                .col-xl-5, .col-xl-6, .col-xl-7, .col-xl-8,
                .col-xl-9, .col-xl-10, .col-xl-11, .col-xl-12,
                .col-xxl-1, .col-xxl-2, .col-xxl-3, .col-xxl-4,
                .col-xxl-5, .col-xxl-6, .col-xxl-7, .col-xxl-8,
                .col-xxl-9, .col-xxl-10, .col-xxl-11, .col-xxl-12 {
                    flex: 0 0 100%;
                    max-width: 100%;
                }
            }

            /* Button Size Variants */
            .btn-sm {
                padding: 0.65rem 1.5rem !important;
                font-size: 0.85rem !important;
                min-width: 120px !important;
                height: 38px !important;
            }

            /* Extra Small Button Styles */
            .btn-xs {
                padding: 0.5rem 1rem !important;
                font-size: 0.75rem !important;
                min-width: 90px !important;
                border-radius: 20px !important;
                height: 32px !important;
            }

            .rounded-btn {
                border-radius: 24px !important;
                padding: 0.5rem 1.2rem !important;
                font-size: 0.85rem !important;
                min-width: 100px;
                height: 36px;
            }

            /* Colorful Button Styles */
            .btn-primary {
                background: var(--gradient-primary) !important;
                color: white !important;
                border: none !important;
                box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3) !important;
            }

            .btn-mint {
                background: var(--gradient-mint) !important;
                color: white !important;
                border: none !important;
                box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3) !important;
            }

            .btn-purple {
                background: var(--gradient-purple) !important;
                color: white !important;
                border: none !important;
                box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3) !important;
            }

            .btn-hazel {
                background: var(--gradient-hazel) !important;
                color: white !important;
                border: none !important;
                box-shadow: 0 4px 12px rgba(234, 179, 8, 0.3) !important;
            }

            .btn-danger {
                background: var(--gradient-danger) !important;
                color: white !important;
                border: none !important;
                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3) !important;
            }

            .btn-info {
                background: var(--gradient-info) !important;
                color: white !important;
                border: none !important;
                box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3) !important;
            }

            /* لون جديد لزر Preview PDF */
            .btn-preview {
                background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%) !important;
                color: white !important;
                border: none !important;
                box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3) !important;
            }

            /* Hover Effects for Buttons */
            .btn-primary:hover {
                background: linear-gradient(135deg, var(--primary-600), var(--primary-800)) !important;
                transform: translateY(-3px) scale(1.05) !important;
                box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4) !important;
            }

            .btn-mint:hover {
                background: linear-gradient(135deg, var(--mint-600), var(--mint-800)) !important;
                transform: translateY(-3px) scale(1.05) !important;
                box-shadow: 0 6px 20px rgba(20, 184, 166, 0.4) !important;
            }

            .btn-purple:hover {
                background: linear-gradient(135deg, var(--purple-600), var(--purple-800)) !important;
                transform: translateY(-3px) scale(1.05) !important;
                box-shadow: 0 6px 20px rgba(168, 85, 247, 0.4) !important;
            }

            .btn-hazel:hover {
                background: linear-gradient(135deg, var(--hazel-600), var(--hazel-800)) !important;
                transform: translateY(-3px) scale(1.05) !important;
                box-shadow: 0 6px 20px rgba(234, 179, 8, 0.4) !important;
            }

            .btn-danger:hover {
                background: linear-gradient(135deg, var(--danger-600), var(--danger-800)) !important;
                transform: translateY(-3px) scale(1.05) !important;
                box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4) !important;
            }

            .btn-preview:hover {
                background: linear-gradient(135deg, #7c3aed, #6b21a8) !important;
                transform: translateY(-3px) scale(1.05) !important;
                box-shadow: 0 6px 20px rgba(147, 51, 234, 0.4) !important;
            }

            /* Active/Pressed State */
            .btn-primary:active,
            .btn-mint:active,
            .btn-purple:active,
            .btn-hazel:active,
            .btn-danger:active,
            .btn-preview:active {
                transform: translateY(0) scale(1) !important;
                box-shadow: 0 2px 8px rgba(15, 23, 42, 0.2) !important;
            }

            /* Disabled State */
            .btn-primary.ui-state-disabled,
            .btn-mint.ui-state-disabled,
            .btn-purple.ui-state-disabled,
            .btn-hazel.ui-state-disabled,
            .btn-danger.ui-state-disabled,
            .btn-preview.ui-state-disabled {
                opacity: 0.6 !important;
                background: var(--surface-300) !important;
                color: var(--surface-600) !important;
                box-shadow: none !important;
                transform: none !important;
            }

            /* علامات الحقول الإجبارية */
            .field-required .smat-label::after {
                content: " *";
                color: var(--danger-500);
                font-weight: bold;
                margin-left: 2px;
            }

            .field-required .smat-label {
                position: relative;
            }

            .field-required .smat-label::before {
                content: "";
                position: absolute;
                left: -16px;
                top: 50%;
                transform: translateY(-50%);
                width: 8px;
                height: 8px;
                background-color: var(--danger-500);
                border-radius: 50%;
                animation: pulse 2s infinite;
                box-shadow: 0 0 0 2px rgba(217, 119, 110, 0.4);
            }

            @keyframes pulse {
                0% {
                    transform: translateY(-50%) scale(1);
                    opacity: 1;
                }
                50% {
                    transform: translateY(-50%) scale(1.2);
                    opacity: 0.7;
                }
                100% {
                    transform: translateY(-50%) scale(1);
                    opacity: 1;
                }
            }

            /* تحسين مظهر الحقول الإجبارية */
            .field-required .ui-inputtext,
            .field-required .ui-selectonemenu,
            .field-required .ui-inputtextarea,
            .field-required .ui-calendar {
                border-left: 3px solid var(--danger-300) !important;
                background-color: var(--danger-50) !important;
            }

            .field-required .ui-inputtext:focus,
            .field-required .ui-selectonemenu:focus,
            .field-required .ui-inputtextarea:focus,
            .field-required .ui-calendar:focus {
                border-color: var(--danger-500) !important;
                box-shadow: 0 0 0 3px var(--danger-100), var(--shadow-md) !important;
            }

            /* تحسينات إضافية للخطوط */
            p, span, div, td, li {
                font-family: 'Inter', sans-serif;
                letter-spacing: -0.01em;
            }

            strong, b {
                font-weight: 600;
            }

            /* تحسين التباعد بين العناصر */
            .row {
                margin-bottom: 0.5rem;
            }

            /* تحسين مظهر الأيقونات */
            .pi {
                font-size: 1.1em;
            }

            /* تحسين مظهر الرسائل */
            .ui-message {
                font-family: 'Inter', sans-serif;
                font-size: 0.875rem;
                margin-top: 0.25rem;
            }

            /* تحسين مظهر التبويبات إذا وجدت */
            .ui-tabs .ui-tabs-nav li {
                font-family: 'Poppins', sans-serif;
                font-weight: 500;
            }

            /* تحسين مظهر القوائم المنسدلة */
            .ui-selectonemenu-items {
                font-family: 'Inter', sans-serif;
            }

            /* تحسين مظهر عناصر الواجهة الصغيرة */
            small, .small-text {
                font-size: 0.8125rem;
                font-family: 'Inter', sans-serif;
            }

            /* Custom Scrollbar */
            ::-webkit-scrollbar {
                width: 10px;
                height: 10px;
            }

            ::-webkit-scrollbar-track {
                background: rgba(203, 213, 225, 0.1);
                border-radius: 10px;
            }

            ::-webkit-scrollbar-thumb {
                background: linear-gradient(to bottom, var(--primary-400), var(--primary-600));
                border-radius: 10px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(to bottom, var(--primary-500), var(--primary-700));
            }

            /* Premium Section Headers */
            .section-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 2rem;
                padding-bottom: 1rem;
                border-bottom: 1px solid rgba(203, 213, 225, 0.3);
                position: relative;
            }

            .section-header:after {
                content: "";
                position: absolute;
                bottom: -1px;
                left: 0;
                width: 100px;
                height: 2px;
                background: var(--gradient-primary);
                border-radius: 2px;
            }

            /* Template Scroll Container */
            .template-scroll-container {
                overflow-x: auto;
                overflow-y: hidden;
                width: 100%;
                border: 1px solid rgba(203, 213, 225, 0.3);
                border-radius: var(--radius-lg);
                margin-top: 1.5rem;
                padding: 1rem;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.98) 100%);
                box-shadow: var(--shadow-md), var(--glass-shadow);
                backdrop-filter: blur(8px);
                position: relative;
            }

            .template-scroll-content {
                min-width: 100%;
                width: auto;
                white-space: nowrap;
                padding: 0.5rem;
            }

            .scroll-indicator {
                text-align: center;
                color: var(--primary-600);
                font-size: 0.8rem;
                margin-top: 0.5rem;
                font-style: italic;
                font-family: 'Poppins', sans-serif;
                background: linear-gradient(90deg, transparent, var(--primary-100), transparent);
                padding: 0.5rem;
                border-radius: var(--radius-full);
                border: 1px dashed var(--primary-200);
            }

            .scroll-indicator i {
                color: var(--primary-500);
                margin: 0 0.5rem;
                animation: bounce 2s infinite;
            }

            @keyframes bounce {
                0%, 100% { transform: translateX(0); }
                50% { transform: translateX(5px); }
            }

            /* تحسين مظهر الجدول داخل حاوية التمرير */
            .template-scroll-container .custom-panel-grid {
                margin-bottom: 0;
                box-shadow: none;
                border: 1px solid rgba(203, 213, 225, 0.2);
            }

            .template-scroll-container .custom-panel-grid tr td {
                white-space: nowrap;
                min-width: 120px;
            }

            /* تأثيرات تفاعلية لحاوية التمرير */
            .template-scroll-container:hover {
                box-shadow: var(--shadow-lg), 0 0 20px rgba(14, 165, 233, 0.1);
                border-color: var(--primary-300);
            }

            /* شريط التمرير المخصص للحاوية */
            .template-scroll-container::-webkit-scrollbar {
                height: 8px;
            }

            .template-scroll-container::-webkit-scrollbar-track {
                background: rgba(203, 213, 225, 0.1);
                border-radius: 4px;
            }

            .template-scroll-container::-webkit-scrollbar-thumb {
                background: linear-gradient(90deg, var(--primary-400), var(--primary-600));
                border-radius: 4px;
                border: 1px solid rgba(226, 232, 240, 0.3);
            }

            .template-scroll-container::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(90deg, var(--primary-500), var(--primary-700));
            }

            /* إجبار العرض المطلوب، متوافق مع PrimeFaces */
            .smat-select-short.ui-selectonemenu {
                width: 140px !important;
                min-width: 140px !important;
                max-width: none !important;
                display: inline-block;
                box-sizing: border-box;
                vertical-align: middle;
            }

            .smat-select-short .ui-selectonemenu-label,
            .smat-select-short .ui-selectonemenu-label .ui-selectonemenu-value {
                display: inline-block;
                width: calc(100% - 1.5rem);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* responsive: على الموبايل يرجع يعرض كامل العمود */
            @media (max-width: 768px) {
                .smat-select-short.ui-selectonemenu {
                    width: 100% !important;
                    min-width: 0 !important;
                }
            }

            /* تصميم جديد لقسم إدارة المسودات باللون الأخضر الفاتح */
            .draft-management-section {
                background: linear-gradient(135deg, rgba(240, 253, 250, 0.95) 0%, rgba(204, 251, 241, 0.98) 100%);
                border-radius: var(--radius-xl);
                border: 1px solid rgba(20, 184, 166, 0.3);
                box-shadow: var(--shadow-md), 0 0 15px rgba(20, 184, 166, 0.1);
                padding: 1.5rem;
                margin-bottom: 2rem;
                position: relative;
                overflow: hidden;
                transition: var(--transition);
            }

            .draft-management-section::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: var(--gradient-mint);
                z-index: 1;
            }

            .draft-management-section:hover {
                box-shadow: var(--shadow-lg), 0 0 20px rgba(20, 184, 166, 0.15);
                transform: translateY(-2px);
            }

            .draft-management-header {
                display: flex;
                align-items: center;
                margin-bottom: 1rem;
                padding-bottom: 0.75rem;
                border-bottom: 1px solid rgba(20, 184, 166, 0.2);
            }

            .draft-management-header i {
                color: var(--mint-500);
                font-size: 1.5rem;
                margin-right: 0.75rem;
                filter: drop-shadow(0 0 3px rgba(20, 184, 166, 0.5));
            }

            .draft-management-header h4 {
                color: var(--mint-800);
                margin: 0;
                font-family: 'Playfair Display', serif;
                font-weight: 600;
                background: var(--gradient-mint);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .draft-buttons-container {
                display: flex;
                gap: 1rem;
                justify-content: center;
                align-items: center;
                flex-wrap: wrap;
            }

            .draft-button-rounded {
                border-radius: 25px !important;
                padding: 0.85rem 2rem !important;
                min-width: 160px !important;
                height: 48px !important;
            }

            .draft-button-rounded.draft-button-save {
                background: var(--gradient-mint) !important;
                color: white !important;
                border: none !important;
                box-shadow: 0 4px 15px rgba(20, 184, 166, 0.3) !important;
            }

            .draft-button-rounded.draft-button-load {
                background: var(--gradient-primary) !important;
                color: white !important;
                border: none !important;
                box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3) !important;
            }

            /* زر أبيض بسيط داخل قسم المسودات */
            .draft-button-white {
                background: #ffffff !important;
                color: var(--surface-800) !important;
                border: 1px solid rgba(15,23,42,0.06) !important;
                box-shadow: none !important;
            }

            .draft-button-white:hover {
                transform: translateY(-2px) !important;
                box-shadow: 0 6px 18px rgba(15,23,42,0.06) !important;
            }

            /* تصميم محسّن بشكل كبير لـ Load Last Fill في الأعلى */
            .top-load-last-container {
                position: fixed;
                top: 80px;
                left: 0;
                right: 0;
                z-index: 11000;
                display: flex;
                justify-content: center;
                align-items: center;
                pointer-events: none;
            }

            .top-load-last-wrapper {
                background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.98) 0%,
                rgba(248, 250, 252, 0.98) 100%);
                border-radius: var(--radius-xl);
                padding: 0.75rem 1.5rem;
                box-shadow:
                        var(--shadow-2xl),
                        0 8px 32px rgba(255, 77, 139, 0.15),
                        0 0 0 1px rgba(255, 255, 255, 0.4);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.6);
                display: flex;
                align-items: center;
                gap: 1.25rem;
                pointer-events: auto;
                transform: translateY(-20px);
                opacity: 0;
                animation: elegantSlideDown 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
                position: relative;
                overflow: hidden;
                min-width: 420px;
            }

            /* تأثير خلفية متوهجة */
            .top-load-last-wrapper::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(
                        135deg,
                        rgba(255, 122, 89, 0.05) 0%,
                        rgba(255, 77, 139, 0.05) 50%,
                        rgba(147, 51, 234, 0.05) 100%
                );
                z-index: -1;
                border-radius: inherit;
            }

            /* حدود متدرجة */
            .top-load-last-wrapper::after {
                content: '';
                position: absolute;
                top: -1px;
                left: -1px;
                right: -1px;
                bottom: -1px;
                background: linear-gradient(
                        135deg,
                        rgba(255, 122, 89, 0.3),
                        rgba(255, 77, 139, 0.3),
                        rgba(147, 51, 234, 0.3)
                );
                border-radius: calc(var(--radius-xl) + 1px);
                z-index: -2;
                opacity: 0.8;
            }

            .top-load-last-label {
                font-family: 'Poppins', sans-serif;
                font-weight: 600;
                font-size: 0.95rem;
                color: var(--surface-700);
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 0;
                position: relative;
                overflow: hidden;
            }

            .top-load-last-label::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                        90deg,
                        transparent,
                        rgba(255, 255, 255, 0.8),
                        transparent
                );
                transition: left 0.7s ease;
            }

            .top-load-last-wrapper:hover .top-load-last-label::before {
                left: 100%;
            }

            .top-load-last-label i {
                color: #ff7a59;
                font-size: 1.1rem;
                filter: drop-shadow(0 2px 4px rgba(255, 122, 89, 0.3));
                animation: gentlePulse 3s ease-in-out infinite;
            }

            .btn-highlight {
                background: linear-gradient(135deg,
                #ff7a59 0%,
                #ff4d8b 50%,
                #9333ea 100%) !important;
                color: white !important;
                border: none !important;
                box-shadow:
                        0 4px 15px rgba(255, 77, 139, 0.3),
                        inset 0 1px 1px rgba(255, 255, 255, 0.2) !important;
                padding: 0.85rem 2rem !important;
                font-weight: 700 !important;
                font-size: 0.95rem !important;
                border-radius: var(--radius-full) !important;
                height: 46px !important;
                min-width: 200px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 0.75rem !important;
                position: relative;
                overflow: hidden;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
                letter-spacing: 0.3px;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            }

            /* تأثير التوهج للزر */
            .btn-highlight::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                        90deg,
                        transparent,
                        rgba(255, 255, 255, 0.4),
                        transparent
                );
                transition: left 0.8s ease;
            }

            .btn-highlight:hover::before {
                left: 100%;
            }

            /* تأثير الظل عند التحويم */
            .btn-highlight:hover {
                transform: translateY(-3px) scale(1.03) !important;
                box-shadow:
                        0 8px 25px rgba(255, 77, 139, 0.4),
                        inset 0 1px 1px rgba(255, 255, 255, 0.3) !important;
            }

            .btn-highlight:active {
                transform: translateY(0) scale(1) !important;
                box-shadow:
                        0 2px 10px rgba(255, 77, 139, 0.3),
                        inset 0 1px 1px rgba(255, 255, 255, 0.2) !important;
            }

            .pulse-glow {
                animation: elegantPulseGlow 2.5s ease-in-out infinite;
            }

            @keyframes elegantPulseGlow {
                0% {
                    transform: scale(1);
                    box-shadow:
                            0 4px 15px rgba(255, 77, 139, 0.3),
                            inset 0 1px 1px rgba(255, 255, 255, 0.2);
                }
                50% {
                    transform: scale(1.02);
                    box-shadow:
                            0 8px 30px rgba(255, 77, 139, 0.5),
                            0 0 20px rgba(255, 77, 139, 0.3),
                            inset 0 1px 1px rgba(255, 255, 255, 0.3);
                }
                100% {
                    transform: scale(1);
                    box-shadow:
                            0 4px 15px rgba(255, 77, 139, 0.3),
                            inset 0 1px 1px rgba(255, 255, 255, 0.2);
                }
            }

            @keyframes elegantSlideDown {
                from {
                    transform: translateY(-30px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            @keyframes gentlePulse {
                0%, 100% {
                    transform: scale(1);
                    opacity: 1;
                }
                50% {
                    transform: scale(1.1);
                    opacity: 0.8;
                }
            }

            .draft-button-rounded:hover {
                transform: translateY(-3px) scale(1.05) !important;
                box-shadow: 0 6px 20px rgba(20, 184, 166, 0.4) !important;
            }

            .draft-description {
                text-align: center;
                margin-top: 1rem;
                color: var(--mint-700);
                font-size: 0.875rem;
                font-style: italic;
                font-family: 'Inter', sans-serif;
            }

            /* تأثير التوهج */
            .mint-glow {
                animation: mintGlowEffect 1s ease-in-out !important;
                border-color: var(--mint-400) !important;
            }

            .purple-glow {
                animation: purpleGlowEffect 1s ease-in-out !important;
                border-color: var(--purple-400) !important;
            }

            .hazel-glow {
                animation: hazelGlowEffect 1s ease-in-out !important;
                border-color: var(--hazel-400) !important;
            }

            @keyframes mintGlowEffect {
                0% {
                    box-shadow: 0 0 5px rgba(20, 184, 166, 0.3);
                    transform: scale(1);
                }
                50% {
                    box-shadow: 0 0 20px rgba(20, 184, 166, 0.6), 0 0 30px rgba(20, 184, 166, 0.4);
                    transform: scale(1.02);
                }
                100% {
                    box-shadow: 0 0 5px rgba(20, 184, 166, 0.3);
                    transform: scale(1);
                }
            }

            @keyframes purpleGlowEffect {
                0% {
                    box-shadow: 0 0 5px rgba(168, 85, 247, 0.3);
                    transform: scale(1);
                }
                50% {
                    box-shadow: 0 0 20px rgba(168, 85, 247, 0.6), 0 0 30px rgba(168, 85, 247, 0.4);
                    transform: scale(1.02);
                }
                100% {
                    box-shadow: 0 0 5px rgba(168, 85, 247, 0.3);
                    transform: scale(1);
                }
            }

            @keyframes hazelGlowEffect {
                0% {
                    box-shadow: 0 0 5px rgba(234, 179, 8, 0.3);
                    transform: scale(1);
                }
                50% {
                    box-shadow: 0 0 20px rgba(234, 179, 8, 0.6), 0 0 30px rgba(234, 179, 8, 0.4);
                    transform: scale(1.02);
                }
                100% {
                    box-shadow: 0 0 5px rgba(234, 179, 8, 0.3);
                    transform: scale(1);
                }
            }

            /* مؤشر التحميل */
            .loading-indicator {
                background: rgba(255, 255, 255, 0.95);
                border-radius: var(--radius-lg);
                border: 1px solid var(--primary-200);
                box-shadow: var(--shadow-md);
                margin: 1rem 0;
                animation: fadeIn 0.3s ease;
            }

            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }

            /* رسالة نجاح حفظ المسودة */
            .draft-success-message {
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--gradient-success);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-xl), 0 5px 20px rgba(34, 197, 94, 0.4);
                z-index: 10000;
                transform: translateX(400px);
                opacity: 0;
                transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                min-width: 280px;
            }

            .draft-success-message.show {
                transform: translateX(0);
                opacity: 1;
            }

            .draft-success-message .message-content {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                font-family: 'Poppins', sans-serif;
                font-weight: 600;
                font-size: 0.95rem;
            }

            .draft-success-message .pi-check-circle {
                font-size: 1.4rem;
                color: rgba(255, 255, 255, 0.9);
                filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
            }

            /* تأثير اهتزاز بسيط للرسالة */
            @keyframes gentleBounce {
                0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
                40% {transform: translateY(-5px);}
                60% {transform: translateY(-3px);}
            }

            .draft-success-message.show {
                transform: translateX(0);
                opacity: 1;
                animation: gentleBounce 0.6s ease;
            }

            /* تصميم قسم المرفقات باللون البنفسجي */
            .attachments-section {
                margin-top: 2rem;
                padding: 1.5rem;
                background: linear-gradient(135deg, rgba(250, 245, 255, 0.95) 0%, rgba(243, 232, 255, 0.98) 100%);
                border-radius: var(--radius-xl);
                border: 1px solid rgba(168, 85, 247, 0.3);
                box-shadow: var(--shadow-md), 0 0 15px rgba(168, 85, 247, 0.1);
                position: relative;
                overflow: hidden;
                transition: var(--transition);
            }

            .attachments-section::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: var(--gradient-purple);
                z-index: 1;
            }

            .attachments-section:hover {
                box-shadow: var(--shadow-lg), 0 0 20px rgba(168, 85, 247, 0.15);
                transform: translateY(-2px);
            }

            .attachments-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 1.5rem;
                padding-bottom: 0.75rem;
                border-bottom: 1px solid rgba(168, 85, 247, 0.2);
            }

            .attachments-title {
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            .attachments-title i {
                color: var(--purple-500);
                font-size: 1.5rem;
                filter: drop-shadow(0 0 3px rgba(168, 85, 247, 0.5));
            }

            .attachments-title h4 {
                color: var(--purple-800);
                margin: 0;
                font-family: 'Playfair Display', serif;
                font-weight: 600;
                background: var(--gradient-purple);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .attachments-count {
                background: var(--gradient-purple);
                color: white;
                border-radius: var(--radius-full);
                padding: 0.35rem 0.75rem;
                font-size: 0.8rem;
                font-weight: 600;
                box-shadow: var(--shadow-sm);
            }

            .attachments-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 1.25rem;
                margin-top: 1rem;
            }

            .attachment-card {
                background: var(--surface-0);
                border-radius: var(--radius-lg);
                border: 1px solid rgba(168, 85, 247, 0.2);
                box-shadow: var(--shadow-sm);
                padding: 1.25rem;
                transition: var(--transition);
                position: relative;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }

            .attachment-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 3px;
                background: var(--gradient-purple);
                opacity: 0;
                transition: var(--transition);
            }

            .attachment-card:hover {
                transform: translateY(-5px);
                box-shadow: var(--shadow-lg), 0 5px 15px rgba(168, 85, 247, 0.2);
                border-color: var(--purple-300);
            }

            .attachment-card:hover::before {
                opacity: 1;
            }

            .attachment-header {
                display: flex;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .attachment-icon {
                width: 48px;
                height: 48px;
                border-radius: var(--radius-md);
                background: linear-gradient(135deg, var(--purple-100), var(--purple-200));
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                box-shadow: var(--shadow-sm);
                border: 1px solid var(--purple-200);
            }

            .attachment-icon i {
                font-size: 1.5rem;
                color: var(--purple-600);
            }

            .attachment-info {
                flex: 1;
                min-width: 0;
            }

            .attachment-code {
                font-size: 0.75rem;
                color: var(--purple-600);
                font-weight: 600;
                margin-bottom: 0.25rem;
                font-family: 'Poppins', sans-serif;
            }

            .attachment-name {
                font-weight: 600;
                color: var(--surface-800);
                margin-bottom: 0.25rem;
                font-size: 0.9rem;
                line-height: 1.3;
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
            }

            .attachment-meta {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 0.75rem;
                color: var(--surface-600);
            }

            .attachment-actions {
                display: flex;
                gap: 0.5rem;
                margin-top: auto;
                padding-top: 0.75rem;
                border-top: 1px solid rgba(168, 85, 247, 0.1);
            }

            .attachment-action-btn {
                flex: 1;
                padding: 0.5rem;
                border-radius: var(--radius-md);
                background: var(--surface-50);
                border: 1px solid var(--purple-100);
                color: var(--purple-700);
                font-size: 0.8rem;
                font-weight: 500;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.4rem;
                transition: var(--transition);
                text-decoration: none;
                cursor: pointer;
            }

            .attachment-action-btn:hover {
                background: var(--purple-50);
                color: var(--purple-800);
                border-color: var(--purple-300);
                transform: translateY(-2px);
                box-shadow: var(--shadow-sm);
            }

            .attachment-action-btn.download {
                background: var(--gradient-success);
                color: white;
                border-color: var(--success-500);
            }

            .attachment-action-btn.download:hover {
                background: linear-gradient(135deg, var(--success-600), var(--success-700));
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
            }

            .attachment-action-btn.delete {
                background: var(--gradient-danger) !important;
                color: white !important;
                border-color: var(--danger-500);
            }

            .attachment-action-btn.delete:hover {
                background: linear-gradient(135deg, var(--danger-600), var(--danger-700)) !important;
                color: white !important;
                border-color: var(--danger-600) !important;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4) !important;
            }

            .no-attachments {
                text-align: center;
                padding: 3rem 2rem;
                color: var(--surface-600);
            }

            .no-attachments i {
                font-size: 3rem;
                color: var(--purple-300);
                margin-bottom: 1rem;
                display: block;
            }

            .no-attachments p {
                margin: 0;
                font-size: 1rem;
                font-family: 'Inter', sans-serif;
            }

            /* تحسينات للزر Download All */
            .download-all-btn {
                background: var(--gradient-primary) !important;
                color: white !important;
                border: none !important;
                box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3) !important;
                border-radius: var(--radius-full) !important;
                padding: 0.65rem 1.5rem !important;
                font-weight: 600 !important;
                display: flex !important;
                align-items: center !important;
                gap: 0.5rem !important;
                transition: var(--transition) !important;
            }

            .download-all-btn:hover {
                background: linear-gradient(135deg, var(--primary-600), var(--primary-800)) !important;
                transform: translateY(-2px) !important;
                box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4) !important;
            }

            /* تأثيرات إضافية للزر الأحمر */
            .attachment-action-btn.delete {
                position: relative;
                overflow: hidden;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .attachment-action-btn.delete::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 5px;
                height: 5px;
                background: rgba(255, 255, 255, 0.5);
                opacity: 0;
                border-radius: 100%;
                transform: scale(1, 1) translate(-50%);
                transform-origin: 50% 50%;
            }

            .attachment-action-btn.delete:hover::after {
                animation: ripple-red 1s ease-out;
            }

            @keyframes ripple-red {
                0% {
                    transform: scale(0, 0);
                    opacity: 0.5;
                }
                100% {
                    transform: scale(20, 20);
                    opacity: 0;
                }
            }

            /* تحسينات التجاوب */
            @media (max-width: 768px) {
                .attachments-grid {
                    grid-template-columns: 1fr;
                    gap: 1rem;
                }

                .attachments-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 1rem;
                }

                .attachment-card {
                    padding: 1rem;
                }

                .attachment-header {
                    flex-direction: column;
                    align-items: flex-start;
                }

                .attachment-icon {
                    align-self: flex-start;
                }

                /* تصميم محسّن للجوال */
                .top-load-last-container {
                    top: 70px;
                    padding: 0 1rem;
                }

                .top-load-last-wrapper {
                    flex-direction: column;
                    gap: 0.75rem;
                    padding: 1.25rem;
                    min-width: auto;
                    width: 100%;
                    max-width: 100%;
                }

                .btn-highlight {
                    min-width: 100% !important;
                    padding: 0.75rem 1.5rem !important;
                    font-size: 0.9rem !important;
                    height: 44px !important;
                }

                .top-load-last-label {
                    text-align: center;
                    font-size: 0.9rem;
                    justify-content: center;
                }
            }

            @media (max-width: 480px) {
                .top-load-last-container {
                    top: 65px;
                    padding: 0 0.75rem;
                }

                .top-load-last-wrapper {
                    padding: 1rem;
                }

                .btn-highlight {
                    padding: 0.7rem 1.25rem !important;
                    font-size: 0.85rem !important;
                    height: 42px !important;
                }

                .top-load-last-label {
                    font-size: 0.85rem;
                }
            }

            /* إطار أزرق رفيع وجميل للحقول في قسم القالب */
            .template-scroll-container .ui-inputtext,
            .template-scroll-container .ui-selectonemenu,
            .template-scroll-container .ui-inputtextarea,
            .template-scroll-container .ui-calendar,
            .template-scroll-container .ui-chkbox-box {
                border: 1.5px solid var(--primary-300) !important;
                border-radius: var(--radius-sm) !important;
                box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.1) !important;
                transition: var(--transition) !important;
                position: relative;
            }

            .template-scroll-container .ui-inputtext:focus,
            .template-scroll-container .ui-selectonemenu:focus,
            .template-scroll-container .ui-inputtextarea:focus,
            .template-scroll-container .ui-calendar:focus {
                border-color: var(--primary-500) !important;
                box-shadow: 0 0 0 2px var(--primary-100), 0 2px 8px rgba(14, 165, 233, 0.2) !important;
                outline: none;
            }

            .template-scroll-container .ui-inputtext:hover,
            .template-scroll-container .ui-selectonemenu:hover,
            .template-scroll-container .ui-inputtextarea:hover,
            .template-scroll-container .ui-calendar:hover {
                border-color: var(--primary-400) !important;
                box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.15) !important;
            }

            /* إطار خاص لمربعات الاختيار */
            .template-scroll-container .ui-chkbox .ui-chkbox-box {
                border: 1.5px solid var(--primary-300) !important;
                background: var(--surface-0) !important;
            }

            .template-scroll-container .ui-chkbox .ui-chkbox-box.ui-state-active {
                border-color: var(--primary-500) !important;
                background: var(--gradient-primary) !important;
            }

            .template-scroll-container .ui-chkbox .ui-chkbox-box.ui-state-focus {
                box-shadow: 0 0 0 2px var(--primary-100) !important;
                border-color: var(--primary-500) !important;
            }

            /* إطار خاص للقوائم المنسدلة */
            .template-scroll-container .smat-select-short.ui-selectonemenu {
                border: 1.5px solid var(--primary-300) !important;
                border-radius: var(--radius-sm) !important;
            }

            .template-scroll-container .smat-select-short.ui-selectonemenu:hover {
                border-color: var(--primary-400) !important;
            }

            .template-scroll-container .smat-select-short.ui-selectonemenu:focus {
                border-color: var(--primary-500) !important;
            }

            /* إطار للنصوص في القالب - الحل المصحح */
            .template-scroll-container .template-field-label,
            .template-scroll-container .ui-outputlabel,
            .template-scroll-container span[id*='outputLabel'] {
                display: inline-block;
                padding: 0.5rem 0.75rem;
                border: 1.5px solid var(--primary-200);
                border-radius: var(--radius-sm);
                background: var(--primary-50);
                color: var(--primary-800);
                font-weight: 500;
                margin: 2px;
                min-height: 38px;
                line-height: 1.4;
                display: flex;
                align-items: center;
            }

            /* تحسين مظهر الحقول في الجدول */
            .template-scroll-container .custom-panel-grid tr td {
                padding: 0.75rem;
                vertical-align: middle;
            }

            /* ضمان ظهور الإطار بشكل متسق لجميع العناصر */
            .template-scroll-container .ui-inputtext,
            .template-scroll-container .ui-selectonemenu,
            .template-scroll-container .ui-inputtextarea,
            .template-scroll-container .smat-select-short,
            .template-scroll-container .template-field-label,
            .template-scroll-container .ui-outputlabel,
            .template-scroll-container .ui-chkbox-box {
                min-height: 38px;
                display: flex;
                align-items: center;
            }

            /* تحسين التباعد بين العناصر */
            .template-scroll-container [style*="margin-left:2px;margin-right:2px;"] {
                margin: 2px !important;
            }

            /* توسيع حقل التعليق - الأنماط المضافة والمصححة */
            .comment-field-expanded {
                width: 100% !important;
                min-height: 120px !important;
                resize: vertical;
                font-family: 'Inter', sans-serif;
                font-size: 0.9375rem;
                line-height: 1.6;
                padding: 1rem !important;
            }

            .comment-field-expanded:focus {
                border-color: var(--primary-500) !important;
                box-shadow: 0 0 0 3px var(--primary-100), var(--shadow-lg) !important;
                background-color: var(--primary-50) !important;
            }

            .comment-field-expanded:hover {
                border-color: var(--primary-400) !important;
                background-color: var(--surface-50) !important;
            }

            /* توسيع حاوية التعليق في البطاقة */
            .comment-section-expanded {
                grid-column: 1 / -1;
                margin-bottom: 2rem;
                padding: 1.5rem;
                background: linear-gradient(135deg, var(--primary-50) 0%, var(--mint-50) 100%);
                border-radius: var(--radius-lg);
                border: 1px solid var(--primary-200);
            }

            /* تحسين تسمية حقل التعليق */
            .comment-label-expanded {
                font-size: 1.1rem !important;
                font-weight: 700 !important;
                color: var(--primary-800) !important;
                margin-bottom: 1rem !important;
                display: block;
                font-family: 'Poppins', sans-serif;
                background: var(--gradient-primary);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
        </style>
    </ui:define>

    <ui:define name="section-content">
        <h:form id="form">
            <p:growl id="messages" widgetVar="growlWV" showDetail="true" showSummary="false" sticky="false" life="10000" />

            <!-- Top center Load Last Fill button (appears only when user has previous form) -->
            <p:outputPanel layout="block" style="pointer-events:none;" rendered="#{inspectionFormBean.inspectorVisible and inspectionFormBean.previousFormExists}">
                <div id="topLoadLastContainer" class="top-load-last-container" style="pointer-events:auto;">
                    <style>
                        /* Recent toggle styles - refined palette  micro-interactions */
                        .recent-toggle {
                            display:flex; align-items:center; gap:0.6rem; border:0; cursor:pointer;
                            padding:0.5rem 1rem; border-radius:999px;
                            background: linear-gradient(90deg, rgba(99,102,241,0.06), rgba(16,185,129,0.03));
                            box-shadow: 0 8px 18px rgba(15,23,42,0.06);
                            transition: transform .14s ease, box-shadow .18s ease, background .18s ease;
                        }
                        .recent-toggle .pi { font-size:1.28rem; color: #06b6d4; }
                        #recentToggleArrow { font-size:1.18rem; transition: transform .22s ease; color:var(--surface-600); display:inline-block; }
                        .recent-toggle:hover { transform: translateY(-3px); box-shadow: 0 18px 40px rgba(2,6,23,0.10); }
                        .recent-toggle:focus { outline: none; box-shadow: 0 0 0 6px rgba(6,182,212,0.08); }
                        .recent-toggle.active { background: linear-gradient(90deg, rgba(14,165,233,0.12), rgba(99,102,241,0.06)); box-shadow: 0 20px 46px rgba(2,6,23,0.12); }
                        .recent-toggle.pulse { animation: recentPulse 2.8s ease-in-out infinite; }
                        @keyframes recentPulse { 0% { box-shadow: 0 0 0 0 rgba(6,182,212,0.18);} 70% { box-shadow: 0 0 0 14px rgba(6,182,212,0);} 100% { box-shadow:0 0 0 0 rgba(6,182,212,0);} }

                        /* Panel show/hide */
                        .recent-forms-panel { transition: opacity .25s ease, transform .25s ease, max-height .28s ease; transform-origin: top center; overflow: hidden; }
                        .recent-forms-panel.collapsed { opacity:0; transform: translateY(-6px) scaleY(.99); max-height:0; }
                        .recent-forms-panel:not(.collapsed) { opacity:1; transform: translateY(0) scaleY(1); max-height:480px; display:block; }

                        /* Card styling */
                        .recent-forms-list { display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap; }
                        .recent-form-card {
                            position: relative;
                            min-width:180px; max-width:220px; padding:0.7rem 0.9rem; border-radius:12px;
                            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
                            border: 1px solid rgba(99,102,241,0.06);
                            box-shadow: 0 8px 22px rgba(2,6,23,0.06); display:flex; flex-direction:column; gap:6px;
                            transition: transform .18s ease, box-shadow .18s ease;
                        }
                        /* Pinned badge (small chip shown on pinned cards) */
                        .pinned-badge {
                            display: none;
                            position: absolute;
                            top: 8px;
                            right: 8px;
                            z-index: 90;
                            background: linear-gradient(90deg,#ef4444,#dc2626);
                            color: #fff;
                            font-size: 0.70rem;
                            font-weight: 700;
                            padding: 4px 8px;
                            border-radius: 999px;
                            box-shadow: 0 6px 18px rgba(220,38,38,0.18);
                            text-transform: uppercase;
                            letter-spacing: 0.04em;
                        }
                        .recent-form-card.pinned .pinned-badge { display: block; }
                        .recent-form-card:hover { transform: translateY(-6px); box-shadow: 0 24px 48px rgba(2,6,23,0.10); }
                        .recent-form-card > div:first-child { font-weight:700; font-size:0.95rem; color: #0f172a; }
                        .recent-form-card > div:nth-child(2) { font-size:0.79rem; color: #6b7280; }

                        /* Button system - modern rounded buttons */
                        .rounded-btn { border-radius:10px; padding:0.55rem 0.9rem; font-weight:600; box-shadow: 0 6px 18px rgba(2,6,23,0.06); transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease; }
                        .rounded-btn:hover { transform: translateY(-2px); }

                        /* Primary (save) */
                        .btn-primary, .ui-button.btn-primary { background: linear-gradient(90deg,#6366f1,#06b6d4); color: #fff !important; border: none; }
                        .ui-button.btn-primary:hover { filter:brightness(.96); }

                        /* Preview (purple) */
                        .btn-preview, .ui-button.btn-preview { background: linear-gradient(90deg,#7c3aed,#4f46e5); color:#fff !important; border:none; }

                        /* Hazel (amber) */
                        .btn-hazel, .ui-button.btn-hazel { background: linear-gradient(90deg,#f59e0b,#f97316); color:#102a43 !important; }

                        /* Danger */
                        .btn-danger, .ui-button.btn-danger { background: linear-gradient(90deg,#ef4444,#dc2626); color:#fff !important; }

                        /* Mint / success */
                        .btn-mint, .ui-button.btn-mint { background: linear-gradient(90deg,#10b981,#06b6d4); color:#fff !important; }

                        /* small/compact button */
                        .btn-xs, .ui-button.btn-xs { padding:0.38rem 0.6rem; font-size:0.86rem; border-radius:8px; }

                        /* ensure icons align nicely */
                        .ui-button .pi { margin-right:0.48rem; }
                        /* Pin button small */
                        .pin-small { border-radius:8px; padding:0.28rem 0.36rem; font-size:0.85rem; }
                        .pin-small.pinned-on { background: linear-gradient(90deg,#06b6d4,#0ea5a4); color: #fff !important; }
                        .pin-corner { position:absolute; top:8px; right:8px; z-index:40; }
                        /* Pin button on main card */
                        .pin-button-main { position:absolute; top:14px; right:14px; z-index:60; border-radius:10px; padding:0.4rem 0.6rem; }

                        /* Pinned card styles (highlighted red when pinned by current user) */
                        .recent-form-card.pinned {
                            background: linear-gradient(180deg,#ef4444,#dc2626) !important;
                            color: #fff !important;
                            border-color: rgba(0,0,0,0.06) !important;
                            box-shadow: 0 18px 40px rgba(220,38,38,0.18);
                        }
                        .recent-form-card.pinned > div { color: #fff !important; }
                        .recent-form-card.pinned .pi { color: #fff !important; }
                        .recent-form-card.pinned .btn-xs { background: rgba(255,255,255,0.06) !important; color: #fff !important; border: 1px solid rgba(255,255,255,0.08) !important; }

                        /* Unpin / pinned button styling */
                        .btn-unpin { background: linear-gradient(90deg,#ef4444,#dc2626) !important; color: #fff !important; border: none !important; }
                        .btn-unpin:hover { filter: brightness(0.95); }

                        /* Main card pinned style */
                        .card.basic-info-card.pinned-main {
                            background: linear-gradient(180deg,#ef4444,#dc2626) !important;
                            color: #fff !important;
                            box-shadow: 0 22px 48px rgba(220,38,38,0.2);
                            border-color: rgba(0,0,0,0.06) !important;
                        }
                        .card.basic-info-card.pinned-main h3, .card.basic-info-card.pinned-main .smat-label { color: #fff !important; }
                    </style>

                    <div class="top-load-last-wrapper" style="display:flex;gap:0.5rem;align-items:center;">
                        <button type="button" id="recentToggleBtn" class="recent-toggle pulse" onclick="toggleRecentPanel();" aria-expanded="false" title="Recent fills">
                            <i class="pi pi-history" aria-hidden="true"></i>
                            <span style="font-weight:700;color:var(--surface-800);">Recent fills</span>
                            <i id="recentToggleArrow" class="pi pi-chevron-down" aria-hidden="true"></i>
                        </button>

                        <div id="recentFormsPanel" class="recent-forms-panel collapsed" aria-hidden="true" style="display:none;">
                            <div class="recent-forms-list" style="display:flex;gap:0.6rem;align-items:center;">
                                <ui:repeat value="#{inspectionFormBean.lastFiveFormsForCategory}" var="recent">
                                    <div class="recent-form-card #{inspectionFormBean.isPinnedByCurrent(recent) ? 'pinned' : ''}" style="background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(248,250,252,0.98));border-radius:12px;padding:0.5rem 0.75rem;box-shadow:var(--shadow-sm);min-width:170px;display:flex;flex-direction:column;gap:6px;align-items:flex-start;">
                                        <div class="pinned-badge">Pinned</div>
                                        <div style="font-weight:700;font-size:0.92rem;color:var(--surface-800);">#{recent.sysUserByInspectionBy.displayName}</div>
                                        <div style="font-size:0.78rem;color:var(--surface-600);">#{inspectionFormBean.formatFormDate(recent)}</div>
                                        <div style="margin-top:6px;width:100%;display:flex;gap:6px;align-items:center;">
                                            <p:commandButton icon="#{inspectionFormBean.isPinnedByCurrent(recent) ? 'pi pi-times' : 'pi pi-bookmark'}" value="#{inspectionFormBean.isPinnedByCurrent(recent) ? 'Unpin' : null}" styleClass="pin-small btn-xs #{inspectionFormBean.isPinnedByCurrent(recent) ? 'pinned-on btn-unpin' : ''}" action="#{inspectionFormBean.togglePinById(recent.id)}" update="@form" process="@this" title="#{inspectionFormBean.isPinnedByCurrent(recent) ? 'Unpin (you)' : (not empty recent.pinnedBy ? 'Pinned by ' + recent.pinnedBy.displayName : 'Pin this form')}" disabled="#{(not empty recent.pinnedBy and recent.pinnedBy.id ne loginBean.user.id) or (not empty recent.sysUserByInspectionBy and recent.sysUserByInspectionBy.id ne loginBean.user.id)}" />
                                            <p:commandButton value="Load" icon="pi pi-history" styleClass="btn-xs btn-primary" action="#{inspectionFormBean.loadFormById(recent.id)}" process="@this" update="@form" onclick="if(!confirm('This will overwrite matching fields with the selected form. Continue?')) return false;" />
                                        </div>
                                    </div>
                                </ui:repeat>
                            </div>
                        </div>
                    </div>
                </div>
            </p:outputPanel>

            <!-- قسم إدارة المسودات الجديد باللون الأخضر الفاتح -->
            <div class="draft-management-section">
                <div class="draft-management-header">
                    <i class="pi pi-cloud-upload"></i>
                    <h4>Draft Management</h4>
                </div>
                <div class="draft-buttons-container">
                    <!-- زر Save Draft مع تصميم جديد -->
                    <p:commandButton value="Save Draft" icon="pi pi-save"
                                     type="button"
                                     onclick="handleSaveDraft();"
                                     styleClass="draft-button-rounded draft-button-save"
                                     rendered="#{inspectionFormBean.inspectorVisible}" />

                    <!-- زر Load Draft مع تصميم جديد وتأثير التوهج -->
                    <p:commandButton value="Load Draft" icon="pi pi-download"
                                     action="#{inspectionFormBean.loadDraft()}"
                                     update="@form" process="@this"
                                     styleClass="draft-button-rounded draft-button-load"
                                     onstart="showLoadingIndicator();"
                                     oncomplete="setTimeout(triggerMintGlow, 1000);"
                                     rendered="#{inspectionFormBean.inspectorVisible}" />


                </div>

                <!-- رسالة نجاح حفظ المسودة -->
                <div id="draftSavedMessage" class="draft-success-message" style="display: none;">
                    <div class="message-content">
                        <i class="pi pi-check-circle"></i>
                        <span>Draft Saved Successfully!</span>
                    </div>
                </div>

                <p:outputPanel rendered="#{inspectionFormBean.inspectorVisible}">
                    <p class="draft-description">
                        Save your progress or load a previously saved draft to continue working
                    </p>
                </p:outputPanel>
            </div>

            <!-- مؤشر التحميل -->
            <p:outputPanel id="loadingIndicator" style="display:none; text-align: center; padding: 1rem;" styleClass="loading-indicator">
                <i class="pi pi-spin pi-spinner" style="font-size: 2rem; color: var(--mint-500);"></i>
                <p style="margin-top: 0.5rem; color: var(--mint-600);">Loading draft, please wait...</p>
            </p:outputPanel>

            <!-- remoteCommand to set savingDraft flag on the server BEFORE the real submit -->
            <p:remoteCommand name="markSavingDraft" actionListener="#{inspectionFormBean.prepareSaveDraft}" process="@this" oncomplete="document.getElementById('form:saveDraftInvoker').click();" />
            <!-- hidden real submit invoked after markSavingDraft completes -->
            <p:commandButton id="saveDraftInvoker" style="display:none" action="#{inspectionFormBean.saveDraft()}" process="@form" update="@([id$=messages])" />

            <script>
                // دالة جديدة للتعامل مع حفظ المسودة
                function handleSaveDraft() {
                    // تشغيل عملية الحفظ الأصلية
                    markSavingDraft();

                    // إظهار رسالة النجاح بعد 0.5 ثانية
                    setTimeout(showSuccessMessage, 500);
                }

                // دالة لإظهار رسالة النجاح
                function showSuccessMessage() {
                    const message = document.getElementById('draftSavedMessage');
                    if (message) {
                        message.style.display = 'block';

                        // إضافة تأثير الظهور
                        setTimeout(() => {
                            message.classList.add('show');
                        }, 10);

                        // إخفاء الرسالة بعد 3 ثوانٍ
                        setTimeout(() => {
                            message.classList.remove('show');
                            setTimeout(() => {
                                message.style.display = 'none';
                            }, 500);
                        }, 3000);
                    }
                }

                // دالة لإظهار مؤشر التحميل
                function showLoadingIndicator() {
                    const indicator = document.querySelector('.loading-indicator');
                    if (indicator) {
                        indicator.style.display = 'block';
                    }
                }

                // دالة محسنة لتأثير التوهج الأخضر
                function triggerMintGlow() {
                    console.log('loading draft');

                    // إخفاء مؤشر التحميل
                    const indicator = document.querySelector('.loading-indicator');
                    if (indicator) {
                        indicator.style.display = 'none';
                    }

                    // تحديد جميع الحقول في النموذج
                    const formElements = document.querySelectorAll('#form input, #form textarea, #form select, #form .ui-inputtext, #form .ui-selectonemenu, #form .ui-inputtextarea, #form .ui-calendar, #form .ui-chkbox-box');

                    console.log('تم العثور على ' + formElements.length + ' عنصر');

                    // إضافة تأثير التوهج لكل حقل
                    formElements.forEach((element, index) => {
                        setTimeout(() => {
                            element.classList.add('mint-glow');

                            // إزالة التأثير بعد انتهاء الرسوم المتحركة
                            setTimeout(() => {
                                element.classList.remove('mint-glow');
                            }, 1000);
                        }, index * 30); // تأثير متتالي للحقول
                    });

                    // إضافة تأثير خاص للبطاقة الرئيسية
                    const mainCard = document.querySelector('.card');
                    if (mainCard) {
                        mainCard.style.transition = 'all 0.5s ease';
                        mainCard.style.boxShadow = '0 0 30px rgba(20, 184, 166, 0.4), var(--shadow-xl)';
                        setTimeout(() => {
                            mainCard.style.boxShadow = '';
                        }, 1000);
                    }

                    // تأثير للنص التوضيحي
                    const draftSection = document.querySelector('.draft-management-section');
                    if (draftSection) {
                        draftSection.style.transition = 'all 0.5s ease';
                        draftSection.style.boxShadow = '0 0 25px rgba(14, 165, 233, 0.4)';
                        setTimeout(() => {
                            draftSection.style.boxShadow = '';
                        }, 1000);
                    }
                }

                // التأكد من تحميل DOM
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('draft loaded successfully');
                });

                // Toggle recent forms panel (collapsible) — improved behavior and button state
                function toggleRecentPanel() {
                    var panel = document.getElementById('recentFormsPanel');
                    var btn = document.getElementById('recentToggleBtn');
                    var arrow = document.getElementById('recentToggleArrow');
                    if (!panel || !btn) return;
                    var isCollapsed = panel.classList.contains('collapsed');
                    if (isCollapsed) {
                        // show
                        panel.style.display = 'block';
                        setTimeout(function() { panel.classList.remove('collapsed'); }, 10);
                        btn.setAttribute('aria-expanded', 'true');
                        panel.setAttribute('aria-hidden', 'false');
                        if (arrow) arrow.style.transform = 'rotate(180deg)';
                        btn.classList.add('active');
                        btn.classList.remove('pulse');
                        // focus the panel for accessibility
                        setTimeout(function() { panel.setAttribute('tabindex','-1'); panel.focus &amp;&amp; panel.focus(); }, 160);
                    } else {
                        // hide
                        panel.classList.add('collapsed');
                        if (arrow) arrow.style.transform = 'rotate(0deg)';
                        btn.setAttribute('aria-expanded', 'false');
                        panel.setAttribute('aria-hidden', 'true');
                        btn.classList.remove('active');
                        // restore pulse after collapse so it draws attention later
                        setTimeout(function() { btn.classList.add('pulse'); }, 600);
                        setTimeout(function() { panel.style.display = 'none'; }, 260);
                    }
                }
            </script>

            <!-- Main Form Card - باللون الأساسي -->
            <div class="card basic-info-card #{inspectionFormBean.isPinnedByCurrent(inspectionFormBean.equipmentInspectionForm) ? 'pinned-main' : ''}">
                <!-- main pin button removed per user request -->
                <div class="section-header">
                    <h3 style="color: var(--blue-700); margin: 0; font-family: 'Playfair Display', serif;">#{inspectionFormBean.formTemplate.title} </h3>
                    <p:badge value="INSPECTION FORM" severity="info" styleClass="badge-lg" />
                </div>

                <!-- Comment Section - موسع -->
                <h:panelGroup rendered="#{!loginBean.hasRole('001')}">
                    <div class="row comment-section-expanded">
                        <div class="col-lg-12 col-xl-12 col-xxl-12">
                            <div class="field">
                                <h:outputText value="#{interfaceLabel.comment}" styleClass="smat-label comment-label-expanded" />
                                <div class="ui-chip" style="width: 100%; max-width: 100%; padding: 1rem;">
                                    <span class="ui-chip-icon pi pi-comment" style="font-size: 1.2rem;"></span>
                                    <div class="ui-chip-text"
                                         style="text-overflow: ellipsis; overflow: hidden; white-space: normal;
                                padding: 8px; width: 100%; line-height: 1.5; min-height: 60px;"
                                         title="#{inspectionFormBean.stepComment}">
                                        #{inspectionFormBean.stepComment}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p:divider layout="horizontal" type="solid" styleClass="mt-4 mb-4" />
                </h:panelGroup>

                <!-- Basic Information Section -->
                <div class="row">
                    <div class="col-lg-6 col-xl-3 col-xxl-3">
                        <div class="field">
                            <h:outputText value="#{interfaceLabel.reportNo}" styleClass="smat-label" />
                            <p:inputText
                                    value="#{inspectionFormBean.equipmentInspectionForm.reportNo}"
                                    disabled="true" styleClass="block input-text-smat-background" />
                        </div>
                    </div>
                    <div class="col-lg-6 col-xl-3 col-xxl-3">
                        <div class="field">
                            <h:outputText value="#{interfaceLabel.timeSheetNo}" styleClass="smat-label" />
                            <p:inputText
                                    value="#{inspectionFormBean.equipmentInspectionForm.timeSheetNo}"
                                    styleClass="block input-text-smat-background" />
                        </div>
                    </div>
                    <div class="col-lg-6 col-xl-3 col-xxl-3">
                        <div class="field">
                            <h:outputText value="#{interfaceLabel.jobNo}" styleClass="smat-label" />
                            <p:inputText
                                    value="#{inspectionFormBean.equipmentInspectionForm.jobNo}"
                                    styleClass="block input-text-smat-background" />
                        </div>
                    </div>
                    <div class="col-lg-6 col-xl-3 col-xxl-3">
                        <div class="field field-required">
                            <h:outputText value="#{interfaceLabel.stickerNo}" styleClass="smat-label" />
                            <p:inputText rendered="#{inspectionFormBean.disabled or inspectionFormBean.disableSticker}"
                                         value="#{inspectionFormBean.equipmentInspectionForm.stickerNo}"
                                         disabled="true" styleClass="block input-text-smat-background" />
                            <p:selectOneMenu id="selectoneMenu_sticker"
                                             style="width:100%;" filter="true" filterMatchMode="contains"
                                             widgetVar="widgetVarSticker" rendered="#{!inspectionFormBean.disabled and !inspectionFormBean.disableSticker}"
                                             converter="omnifaces.SelectItemsIndexConverter"
                                             value="#{inspectionFormBean.equipmentInspectionForm.sticker}">
                                <f:selectItem itemLabel="Select sticker:" value="#{null}" noSelectionOption="false" />
                                <!-- explicit option to save sticker as N\\A -->
                                <f:selectItem itemLabel="N\\A" itemValue="#{inspectionFormBean.naSentinel}" />
                                <f:selectItems
                                        itemLabel="#{stickerVar.stickerNo}"
                                        itemValue="#{stickerVar}" var="stickerVar"
                                        value="#{inspectionFormBean.stickers}" />
                            </p:selectOneMenu>
                        </div>
                    </div>
                </div>

                <!-- Dates Section -->
                <div class="row">
                    <div class="col-lg-6 col-xl-3 col-xxl-3">
                        <div class="field field-required">
                            <h:outputText value="#{interfaceLabel.dateOfThoroughExamination}" styleClass="smat-label" />
                            <p:calendar
                                    value="#{inspectionFormBean.equipmentInspectionForm.dateOfThoroughExamination}"
                                    styleClass="block" showIcon="true" />
                        </div>
                    </div>
                    <div class="col-lg-6 col-xl-3 col-xxl-3">
                        <div class="field field-required">
                            <h:outputText value="#{interfaceLabel.nextExaminationDate}" styleClass="smat-label" />
                            <p:calendar
                                    value="#{inspectionFormBean.equipmentInspectionForm.nextExaminationDate}"
                                    styleClass="block" showIcon="true" />
                        </div>
                    </div>
                    <div class="col-lg-6 col-xl-3 col-xxl-3">
                        <div class="field">
                            <h:outputText value="#{interfaceLabel.previousExaminationDate}" styleClass="smat-label" />
                            <p:calendar
                                    value="#{inspectionFormBean.equipmentInspectionForm.previousExaminationDate}"
                                    styleClass="block" showIcon="true" />
                        </div>
                    </div>
                </div>

                <!-- Company Information - Modified to include address next to company -->
                <div class="row">
                    <div class="col-lg-6 col-xl-6 col-xxl-6">
                        <div class="field field-required">
                            <h:outputText value="#{interfaceLabel.company}" styleClass="smat-label" />
                            <p:selectOneMenu

                                    style="width:100%;"
                                    value="#{inspectionFormBean.equipmentInspectionForm.company}"
                                    converter="omnifaces.SelectItemsIndexConverter"
                                    filter="true"
                                    filterMatchMode="contains"
                                    filterPlaceholder="Search companies...">
                                <f:selectItem itemLabel="#{interfaceLabel.choose}" itemValue="" />
                                <f:selectItems
                                        itemLabel="#{companyVar.name}"
                                        itemValue="#{companyVar}"
                                        var="companyVar"
                                        value="#{inspectionFormBean.companies}" />
                                <p:ajax update="@([id$=companyAddress])" />
                            </p:selectOneMenu>
                        </div>
                    </div>
                    <div class="col-lg-6 col-xl-6 col-xxl-6">
                        <div class="field field-required">
                            <h:outputText value="#{interfaceLabel.nameAndAddressOfEmployer}" styleClass="smat-label" />
                            <p:inputTextarea
                                    id="companyAddress"

                                    value="#{inspectionFormBean.equipmentInspectionForm.company.address}"
                                    styleClass="block"
                                    rows="2" />
                        </div>
                    </div>
                </div>
                <!-- Examination and Equipment Type -->
                <div class="row">
                    <div class="col-lg-6 col-xl-6 col-xxl-6">
                        <div class="field field-required">
                            <h:outputText value="#{interfaceLabel.examinationType}" styleClass="smat-label" />
                            <p:selectOneMenu
                                    style="width:100%;"
                                    value="#{inspectionFormBean.examinationType}"
                                    converter="omnifaces.SelectItemsIndexConverter">
                                <f:selectItems itemLabel="#{examinationType.englishName} "
                                               itemValue="#{examinationType}" var="examinationType"
                                               value="#{inspectionFormBean.examinationTypes}" />
                            </p:selectOneMenu>
                        </div>
                    </div>

                </div>
            </div>



            <p:divider layout="horizontal" type="solid" styleClass="mt-4 mb-4" />

            <!-- Dynamic Content Panel with Horizontal Scroll - باللون البنفسجي -->
            <div class="card dynamic-content-card">


                <!-- إضافة حاوية التمرير الأفقي للقالب -->
                <div class="template-scroll-container">
                    <div class="template-scroll-content">
                        <p:panelGrid id="panelGridDaynamicContent" styleClass="custom-panel-grid" layout="tabular" columns="0">
                            <ui:repeat value="#{inspectionFormBean.formRows}" var="formRow">
                                <p:row>
                                    <ui:repeat
                                            value="#{inspectionFormBean.getFormColumnsPerRow(formRow)}"
                                            var="formColumn">
                                        <p:column colspan="#{formColumn.colSpan}"
                                                  rowspan="#{formColumn.rowSpan}" style="#{formColumn.style}"
                                                  styleClass="#{formColumn.styleClass}">
                                            <ui:repeat
                                                    value="#{inspectionFormBean.getColumnContentByColumn(formColumn)}"
                                                    var="columnContent">

                                                <p:outputLabel style="margin-left:2px;margin-right:2px;"
                                                               styleClass="template-field-label"
                                                               rendered="#{columnContent.generalEquipmentItem.itemType.code eq '01'}"
                                                               value="#{columnContent.generalEquipmentItem.itemText}" />

                                                <p:inputText style="margin-left:2px;margin-right:2px;"
                                                             rendered="#{columnContent.generalEquipmentItem.itemType.code eq '02'}"
                                                             value="#{columnContent.contentValue}" />


                                                <p:selectBooleanCheckbox value="#{columnContent.contentValue}"
                                                                         style="margin-left:2px;margin-right:2px;"
                                                                         rendered="#{columnContent.generalEquipmentItem.itemType.code eq '03'}" />

                                                <p:selectOneMenu
                                                        rendered="#{columnContent.generalEquipmentItem.itemType.code eq '04'}"
                                                        style="margin-left:2px;margin-right:2px;" dynamic="true"
                                                        immediate="true" value="#{columnContent.contentValue}"
                                                        styleClass="smat-select-short">

                                                    <f:selectItems
                                                            itemLabel="#{checklistDetailDataSource.itemValue} "
                                                            itemValue="#{checklistDetailDataSource.itemValue}"
                                                            var="checklistDetailDataSource"
                                                            value="#{inspectionFormBean.getBy(columnContent.generalEquipmentItem.checklistDataSource.code)}" />

                                                </p:selectOneMenu>

                                            </ui:repeat>
                                        </p:column>
                                    </ui:repeat>
                                </p:row>
                            </ui:repeat>
                        </p:panelGrid>
                    </div>
                </div>

                <!-- مؤشر التمرير -->
                <div class="scroll-indicator">
                    <i class="pi pi-arrow-left"></i>
                    Scroll horizontally to view all content
                    <i class="pi pi-arrow-right"></i>
                </div>
            </div>

            <p:divider layout="horizontal" type="solid" styleClass="mt-4 mb-4" />

            <!-- Review and Actions Section - باللون الأزرق -->
            <div class="card approval-card">
                <div class="section-header">
                    <h4 style="color: var(--primary-800); margin: 0; font-family: 'Playfair Display', serif;">
                        <i class="pi pi-check-circle" style="margin-right: 10px;"></i>
                        Approval Process
                    </h4>
                </div>

                <div class="row">
                    <div class="col-12 col-lg-3 col-xl-2 col-xxl-2">
                        <h:outputText value="#{interfaceLabel.reviewerEngineer}"
                                      styleClass="smat-label" rendered="#{!inspectionFormBean.disabled}" />
                    </div>

                    <div class="col-12 col-lg-9 col-xl-10 col-xxl-10">
                        <div class="field field-required">
                            <h:outputText value="#{interfaceLabel.reviewerEngineer}"
                                          styleClass="smat-label" rendered="#{!inspectionFormBean.disabled}" />
                            <p:selectOneMenu id="selectoneMenu_UserAliasRecpient" rendered="#{!inspectionFormBean.disabled}"
                                             style="width:100%;" filter="true"
                                             filterMatchMode="contains"
                                             widgetVar="widgetVar_SelectOneMenu"
                                             converter="omnifaces.SelectItemsIndexConverter"
                                             value="#{inspectionFormBean.selectedUserAliasRecipient}"
                                             required="#{!inspectionFormBean.savingDraft}"
                                             requiredMessage="Reviewer engineer is required">
                                <f:selectItem itemLabel="#{interfaceLabel.choose}" itemValue="#{null}" noSelectionOption="true" />
                                <f:selectItems
                                        itemLabel=" ( #{userAlias.userCode} )#{userAlias.sysUserBySysUser.displayName} / #{userAlias.organizationByOrganization.name} / #{userAlias.jobPosition.name}"
                                        itemValue="#{userAlias}" var="userAlias"
                                        value="#{inspectionFormBean.userAliasRecipientList}" />
                            </p:selectOneMenu>
                            <p:message for="selectoneMenu_UserAliasRecpient" display="icon" />
                        </div>
                    </div>
                </div>

                <!-- حقل التعليق الموسع في قسم الموافقة -->
                <div class="row comment-section-expanded">
                    <div class="col-lg-12 col-xl-12 col-xxl-12">
                        <div class="field">
                            <h:outputText value="Approval Comments" styleClass="smat-label comment-label-expanded" />
                            <p:inputTextarea id="approvalComment" value="#{inspectionFormBean.comment}" rows="6"
                                             styleClass="block comment-field-expanded"
                                             placeholder="Enter your detailed approval comments, feedback, or recommendations here..."
                                             autoResize="true"
                                             maxlength="1000" />
                            <p:message for="approvalComment" display="icon" />
                            <small style="color: var(--surface-500); display: block; margin-top: 0.5rem; font-style: italic;">
                                <i class="pi pi-info-circle"></i> Maximum 1000 characters - Your comments will be included in the approval report
                            </small>
                        </div>
                    </div>
                </div>

                <p:divider type="solid" styleClass="mt-4 mb-4" />

                <div class="row">
                    <div class="#{inspectionFormBean.disabled ? 'col-lg-6 col-xl-6 col-xxl-6' : 'col-lg-12 col-xl-12 col-xxl-12'}">
                        <div class="field">
                            <h:outputLabel value="#{interfaceLabel.inspectionEngineer}"
                                           rendered="#{inspectionFormBean.disabled}"
                                           styleClass="smat-label" />
                            <p:inputText disabled="true"
                                         rendered="#{inspectionFormBean.disabled}"
                                         value="#{inspectionFormBean.equipmentInspectionForm.sysUserByInspectionBy.displayName}"
                                         styleClass="block" style="font-weight:600;color:var(--success-600);font-size: 1rem;" />
                        </div>
                    </div>
                    <div class="#{inspectionFormBean.disabled ? 'col-lg-6 col-xl-6 col-xxl-6' : 'col-lg-12 col-xl-12 col-xxl-12'}">
                        <div class="field">
                            <h:outputLabel
                                    value="#{inspectionFormBean.disabled ? interfaceLabel.reviewerEngineer : interfaceLabel.inspectionEngineer}"
                                    styleClass="smat-label" />
                            <p:inputText disabled="true"
                                         value="#{loginBean.user.displayName}"
                                         styleClass="block" style="font-weight:600;color:var(--success-600);font-size: 1rem;" />
                        </div>
                    </div>
                </div>

                <!-- Attachments section - باللون البنفسجي -->
                <h:panelGroup id="ins_attachments_section" layout="block" styleClass="attachments-section">
                    <div class="attachments-header">
                        <div class="attachments-title">
                            <i class="pi pi-paperclip"></i>
                            <h4>Attachments</h4>
                            <span class="attachments-count">
                                #{not empty inspectionFormBean.attachmentFiles ? inspectionFormBean.attachmentFiles.size() : 0} Files
                            </span>
                        </div>
                        <p:commandButton value="Download All" icon="pi pi-download" type="button"
                                         onclick="(function(){
                                             var container=document.getElementById('ins_attachments_list');
                                             if(!container) return; var ids=[]; container.querySelectorAll('[data-file-id]').forEach(function(el){ ids.push(el.getAttribute('data-file-id')); });
                                             if(ids.length==0){ alert('No attachments to download'); return; }
                                             window.open('#{request.contextPath}/attachments/zipByIds?ids=' + encodeURIComponent(ids.join(',')),'_blank');
                                         })();"
                                         styleClass="download-all-btn"
                                         rendered="#{not empty inspectionFormBean.attachmentFiles}" />
                    </div>

                    <!-- Upload Section -->
                    <div class="field">
                        <p:fileUpload id="inspectionAttachmentsUpload"
                                      mode="advanced"
                                      multiple="true"
                                      dragDropSupport="true"
                                      allowTypes="/(\.|\/)(pdf|jpg|jpeg|png|gif|doc|docx|xls|xlsx|txt)$/"
                                      auto="true"
                                      update=":form:messages :form:ins_attachments_section"
                                      listener="#{inspectionFormBean.handleAttachmentUpload}"
                                      label="Choose Files"
                                      uploadLabel="Upload"
                                      cancelLabel="Cancel"
                                      style="width: 100%;" />
                    </div>

                    <!-- Attachments Grid -->
                    <h:panelGroup id="ins_attachments_wrapper" rendered="#{not empty inspectionFormBean.attachmentFiles}">
                        <div class="attachments-grid" id="ins_attachments_list">
                            <c:forEach items="#{inspectionFormBean.attachmentFiles}" var="archiveDocumentFile" varStatus="loop">
                                <div class="attachment-card" data-file-id="#{archiveDocumentFile.id}">
                                    <div class="attachment-header">
                                        <div class="attachment-icon">
                                            <i class="pi pi-file"></i>
                                        </div>
                                        <div class="attachment-info">
                                            <div class="attachment-code">[#{archiveDocumentFile.code}]</div>
                                            <div class="attachment-name" title="#{archiveDocumentFile.name}">
                                                #{archiveDocumentFile.name}
                                            </div>
                                            <div class="attachment-meta">
                                                <i class="pi pi-calendar"></i>
                                                <span>Uploaded</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="attachment-actions">
                                        <a href="#{request.contextPath}/attachments/raw?archDocFileId=#{archiveDocumentFile.id}"
                                           class="attachment-action-btn download"
                                           target="_blank"
                                           title="Download #{archiveDocumentFile.name}">
                                            <i class="pi pi-download"></i>
                                            Download
                                        </a>
                                        <p:commandButton styleClass="attachment-action-btn delete"
                                                         icon="pi pi-trash"
                                                         value="Delete"
                                                         title="Delete #{archiveDocumentFile.name}"
                                                         action="#{inspectionFormBean.deleteAttachment(archiveDocumentFile.id)}"
                                                         process="@this"
                                                         update=":form:ins_attachments_section :form:messages"
                                                         onclick="if (!confirm('Are you sure you want to delete this attachment?')) return false;" />
                                    </div>
                                </div>
                            </c:forEach>
                        </div>
                    </h:panelGroup>

                    <!-- Empty State -->
                    <h:panelGroup id="ins_empty_attachments" rendered="#{empty inspectionFormBean.attachmentFiles}">
                        <div class="no-attachments">
                            <i class="pi pi-inbox"></i>
                            <p>No attachments uploaded yet</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem; color: var(--surface-500);">
                                Upload files using the button above
                            </p>
                        </div>
                    </h:panelGroup>
                </h:panelGroup>

                <!-- ***** التصحيح المطلوب: إضافة remoteCommand هنا ***** -->
                <!-- Remote command to prepare preview PDF and return a token -->
                <p:remoteCommand name="preparePreviewPdfRemote"
                                 action="#{inspectionFormBean.preparePreviewPdf}"
                                 process="@form"
                                 update=":form:messages"
                                 onstart="PF('statusDialog').show();"
                                 oncomplete="PF('statusDialog').hide(); if (args &amp;&amp; args.previewToken) { window.open('#{request.contextPath}/attachments/previewPdf?token=' + args.previewToken, '_blank'); } else { /* no previewToken returned - check messages */ }" />

                <!-- إعادة تخطيط الأزرار بشكل أنيق -->
                <div class="action-buttons-container">
                    <!-- الأزرار على اليسار -->
                    <div class="left-buttons-group">
                        <!-- زر Preview PDF - لون بنفسجي -->
                        <p:commandButton id="commandButton_preview"
                                         value="Preview PDF"
                                         icon="pi pi-eye"
                                         styleClass="rounded-btn btn-preview"
                                         rendered="#{inspectionFormBean.inspectorVisible}"
                                         type="button"
                                         onclick="preparePreviewPdfRemote(); return false;" />



                        <!-- زر Return to Inspector - لون عسلي -->
                        <p:commandButton id="commandButton_return"
                                         value="#{interfaceLabel.returnToInspector}"
                                         disabled="#{inspectionFormBean.step.equals('03')}"
                                         icon="pi pi-file-edit" rendered="#{inspectionFormBean.disabled}"
                                         pt:data-tooltip="#{interfaceLabel.returnToInspector}"
                                         process="@form" update="@([id$=messages])"
                                         action="#{inspectionFormBean.returnToInspector()}"
                                         styleClass="rounded-btn btn-hazel" />

                        <!-- زر Cancel - لون أحمر -->
                        <p:button id="commandButton_cancel"
                                  value="Return"
                                  icon="pi pi-times"
                                  pt:data-tooltip="Return"
                                  styleClass="rounded-btn btn-danger"
                                  outcome="pretty:inspection/my-tasks" />
                    </div>

                    <!-- الأزرار على اليمين -->
                    <div class="right-buttons-group">
                        <!-- زر Save/Approve - لون أزرق أساسي -->
                        <p:commandButton id="commandButton_save"
                                         value="#{inspectionFormBean.disabled ? 'Approve' : interfaceLabel.save}"
                                         icon="#{inspectionFormBean.disabled ? 'pi pi-check-circle' : 'pi pi-save'}"
                                         pt:data-tooltip="#{inspectionFormBean.disabled ? 'Done' : interfaceLabel.save}"
                                         process="@form" action="#{inspectionFormBean.doSave()}"
                                         update="@form" disabled="#{inspectionFormBean.step.equals('03')}"
                                         styleClass="rounded-btn btn-primary"
                                         outcome="pretty:inspection/my-tasks"
                                         onstart="PF('statusDialog').show();"
                                         oncomplete="if (args &amp;&amp; args.approveOk===false) { PF('statusDialog').hide(); }" />

                        <!-- زر Print - لون أخضر فاتح -->
                        <p:commandButton id="commandButton_print"
                                         rendered="#{inspectionFormBean.step.equals('03')}"
                                         action="#{inspectionFormBean.doPrint()}"
                                         value="#{interfaceLabel.print}" icon="pi pi-print"
                                         pt:data-tooltip="#{interfaceLabel.print}"
                                         styleClass="rounded-btn btn-mint"
                                         onstart="PF('statusDialog').show();"
                                         onclick="window.open('#{request.contextPath}/attachments/zip?type=ins&amp;reportNo=' + encodeURIComponent('#{inspectionFormBean.equipmentInspectionForm.reportNo}'))"
                                         oncomplete="PF('statusDialog').hide(); setTimeout(function(){ window.print(); }, 800);" />
                    </div>
                </div>
            </div>
        </h:form>
    </ui:define>

    <ui:define name="section-dialogs">
        <!-- Premium Status Dialog -->
        <p:dialog modal="true" widgetVar="statusDialog"
                  header="#{interfaceLabel.processing}" draggable="false"
                  closable="false" resizable="false" appendTo="@(body)"
                  style="width:100% !important; height:100% !important; max-width:none;" contentStyle="height:100vh; display:flex; align-items:center; justify-content:center; background:transparent;"
                  styleClass="glass-dialog">
            <div style="text-align: center; padding: 2.5rem;">
                <i class="pi pi-spinner pi-spin" style="font-size: 3.5rem; color: var(--primary-500);"></i>
                <p style="margin-top: 1.75rem; color: var(--text-primary); font-weight: 600; font-size: 1.1rem;">Processing your request...</p>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">Please wait while we complete your action</p>
            </div>
        </p:dialog>

        <!-- Premium Document Viewer Dialog -->
        <p:dialog header="#{interfaceLabel.viewer}" widgetVar="viewerWidgetVar"
                  modal="true" responsive="true" width="90%" height="90%"
                  showEffect="fade" hideEffect="fade" closable="true"
                  draggable="true" resizable="true" maximizable="true"
                  styleClass="max-w-screen">
            <h:form id="form_viewer">
                <p:outputPanel id="manage-viewer-content" style="width:100%;height:100%">
                    <pe:documentViewer id="documentViewer_pdf" height="100%"
                                       zoom="page-width" rendered="true"
                                       value="#{certificateViewerBean.file}" />
                </p:outputPanel>
            </h:form>
        </p:dialog>
    </ui:define>
</ui:composition>